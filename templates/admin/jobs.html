<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jobs — BDB Tools</title>
    <link rel="stylesheet" href="/static/css/style.css?v={{ cache_bust }}">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest-admin.json">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
    <div class="admin-layout">
        {% include 'admin/_nav.html' %}

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
        <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endwith %}

        <h2>Jobs</h2>

        {% if current_user.is_bdb or tokens|length > 1 %}
            <div class="form-group" style="max-width: 300px; margin-bottom: 24px;">
                <label for="token-select">Company</label>
                <select id="token-select" onchange="window.location.href='?token=' + this.value">
                    {% if current_user.is_bdb %}<option value="">All Companies</option>{% endif %}
                    {% for t in tokens %}
                    <option value="{{ t.token }}" {% if selected_token and selected_token.token == t.token %}selected{% endif %}>{{ t.company_name }}</option>
                    {% endfor %}
                </select>
            </div>
        {% else %}
            {% if selected_token %}
            <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 16px;">Company: <strong>{{ selected_token.company_name }}</strong></p>
            {% endif %}
        {% endif %}

        {% if selected_token %}
        <div class="meta-card" style="margin-bottom: 24px;">
            <h3 style="margin-top: 0;">Add Job</h3>
            <form method="POST" action="{{ url_for('time_admin.admin_job_create') }}">
                <input type="hidden" name="token" value="{{ selected_token.token }}">
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="job_name">Job Name</label>
                        <input type="text" id="job_name" name="job_name" placeholder="Main St Renovation" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="customer_id">Customer / Client</label>
                        <select id="customer_id" name="customer_id">
                            <option value="">— Unassigned —</option>
                            {% for c in customers %}
                            <option value="{{ c.id }}">{{ c.company_name }}{% if c.customer_name and c.customer_name != c.company_name %} ({{ c.customer_name }}){% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label for="job_address">Address</label>
                        <input type="text" id="job_address" name="job_address" placeholder="123 Main St, Anytown, USA">
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="button" class="btn btn-blue btn-sm" onclick="geocodeAddress()">Geocode</button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="latitude">Latitude</label>
                        <input type="number" id="latitude" name="latitude" step="any" placeholder="0.000000">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="longitude">Longitude</label>
                        <input type="number" id="longitude" name="longitude" step="any" placeholder="0.000000">
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="submit" class="btn btn-green">Add Job</button>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}

        {% set active_jobs = jobs | selectattr('is_archived', 'equalto', 0) | list %}
        {% set archived_jobs = jobs | selectattr('is_archived', 'equalto', 1) | list %}

        {% if active_jobs %}
        <div class="table-wrap">
            <table class="resizable">
                <thead>
                    <tr>
                        <th>Job Name</th>
                        <th>Customer</th>
                        <th>Address</th>
                        <th>Lat/Lng</th>
                        <th>Reset</th>
                        <th>Status</th>
                        <th>Est. Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in active_jobs %}
                    <tr>
                        <td>
                            <span id="jobname-display-{{ job.id }}">{{ job.job_name }}</span>
                            <input type="text" id="jobname-input-{{ job.id }}" value="{{ job.job_name }}"
                                   style="display: none; width: 100%;">
                        </td>
                        <td>
                            <span id="custname-display-{{ job.id }}" style="font-size: 13px;">{{ job.customer_company_name or '—' }}</span>
                            <select id="custid-input-{{ job.id }}" style="display: none; min-width: 120px;">
                                <option value="">— Unassigned —</option>
                                {% for c in customers %}
                                <option value="{{ c.id }}" {% if job.customer_id == c.id %}selected{% endif %}>
                                    {{ c.company_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <span id="addr-display-{{ job.id }}">{{ job.job_address or '' }}</span>
                            <input type="text" id="addr-input-{{ job.id }}" value="{{ job.job_address or '' }}"
                                   style="display: none; width: 100%;">
                        </td>
                        <td>
                            <span id="latlng-display-{{ job.id }}">
                                {% if job.latitude and job.longitude %}
                                <span style="font-size: 12px;">{{ "%.5f"|format(job.latitude) }}, {{ "%.5f"|format(job.longitude) }}</span>
                                {% else %}
                                <span style="color: var(--gray-400);">--</span>
                                {% endif %}
                            </span>
                            <div id="latlng-edit-{{ job.id }}" style="display: none;">
                                <div style="display: flex; gap: 4px; align-items: center;">
                                    <input type="number" id="lat-input-{{ job.id }}" step="any" placeholder="Lat"
                                           value="{{ job.latitude or '' }}" style="width: 110px; font-size: 12px;">
                                    <input type="number" id="lng-input-{{ job.id }}" step="any" placeholder="Lng"
                                           value="{{ job.longitude or '' }}" style="width: 110px; font-size: 12px;">
                                    <button type="button" class="btn btn-blue btn-sm" style="font-size: 11px; padding: 2px 6px;"
                                            onclick="geocodeJobAddress({{ job.id }})">Geocode</button>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span id="reset-display-{{ job.id }}">
                                {% if job.reset_per_visit %}<span class="badge" style="background:#dbeafe; color:#1d4ed8; font-size:11px;">Reset</span>{% else %}<span style="color:var(--gray-400);">—</span>{% endif %}
                            </span>
                            <label id="reset-edit-{{ job.id }}" style="display:none; font-size:13px; white-space:nowrap;">
                                <input type="checkbox" id="reset-input-{{ job.id }}" {% if job.reset_per_visit %}checked{% endif %}> Reset tasks
                            </label>
                        </td>
                        <td>
                            {% if job.is_active %}
                            <span class="badge badge-active">Active</span>
                            {% else %}
                            <span class="badge badge-inactive">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if job.job_status == 'in_progress' %}
                            <span class="badge" style="background: #dbeafe; color: #1d4ed8;">In Progress</span>
                            {% elif job.job_status == 'accepted' %}
                            <span class="badge" style="background: #dcfce7; color: #15803d;">Accepted</span>
                            {% elif job.job_status == 'pending' %}
                            <span class="badge" style="background: #fef9c3; color: #854d0e;">Pending</span>
                            {% elif job.job_status == 'completed' %}
                            <span class="badge" style="background: #f3f4f6; color: #374151;">Completed</span>
                            {% elif job.job_status == 'declined' %}
                            <span class="badge" style="background: #fee2e2; color: #b91c1c;">Declined</span>
                            {% else %}
                            <span style="color: var(--gray-400);">—</span>
                            {% endif %}
                        </td>
                        <td style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-blue btn-sm" id="jobedit-btn-{{ job.id }}"
                                    onclick="toggleJobEdit({{ job.id }})">Edit</button>
                            <button type="button" class="btn btn-green btn-sm" id="jobsave-btn-{{ job.id }}"
                                    style="display: none;"
                                    onclick="saveJob({{ job.id }})">Save</button>
                            <a href="{{ url_for('time_admin.admin_job_templates', job_id=job.id) }}"
                               class="btn btn-blue btn-sm">Templates</a>
                            <form method="POST" action="{{ url_for('time_admin.admin_job_toggle', job_id=job.id) }}" style="display: inline;">
                                {% if job.is_active %}
                                <button type="submit" class="btn btn-red btn-sm">Deactivate</button>
                                {% else %}
                                <button type="submit" class="btn btn-green btn-sm">Activate</button>
                                {% endif %}
                            </form>
                            <form method="POST" action="{{ url_for('time_admin.admin_job_archive', job_id=job.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-sm" style="background: var(--gray-500); color: #fff;">Archive</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% elif selected_token %}
        <p style="color: var(--gray-500);">No jobs yet.</p>
        {% else %}
        <p style="color: var(--gray-500);">Select a company above to add jobs.</p>
        {% endif %}

        {% if archived_jobs %}
        <h3 style="margin-top: 32px; margin-bottom: 12px;">
            <button type="button" onclick="toggleArchive()" id="archive-toggle"
                    style="background: none; border: none; cursor: pointer; font-size: inherit; font-weight: inherit; color: var(--gray-500); display: flex; align-items: center; gap: 8px; padding: 0;">
                <span id="archive-arrow" style="font-size: 12px;">&#9654;</span>
                Archived Jobs <span style="font-size: 13px; font-weight: 400;">({{ archived_jobs|length }})</span>
            </button>
        </h3>
        <div id="archive-section" style="display: none;">
        <div class="table-wrap">
            <table class="resizable">
                <thead>
                    <tr>
                        <th>Job Name</th>
                        <th>Address</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in archived_jobs %}
                    <tr style="opacity: 0.7;">
                        <td>{{ job.job_name }}</td>
                        <td>{{ job.job_address or '' }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('time_admin.admin_job_unarchive', job_id=job.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-blue btn-sm">Unarchive</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
        {% endif %}
    </div>
    {% include '_footer.html' %}
    <script src="/static/js/admin.js?v={{ cache_bust }}"></script>
    <script>
    function toggleArchive() {
        var section = document.getElementById('archive-section');
        var arrow = document.getElementById('archive-arrow');
        var open = section.style.display !== 'none';
        section.style.display = open ? 'none' : '';
        arrow.innerHTML = open ? '&#9654;' : '&#9660;';
        localStorage.setItem('archiveOpen', open ? '0' : '1');
    }
    (function() {
        if (localStorage.getItem('archiveOpen') === '1') {
            var section = document.getElementById('archive-section');
            var arrow = document.getElementById('archive-arrow');
            if (section) { section.style.display = ''; arrow.innerHTML = '&#9660;'; }
        }
    })();
    </script>
    <script>
    function geocodeAddress() {
        var address = document.getElementById('job_address').value;
        if (!address) { alert('Enter an address first.'); return; }
        fetch('{{ url_for("api_geocode") }}?address=' + encodeURIComponent(address))
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                if (data.lat != null && data.lng != null) {
                    document.getElementById('latitude').value = data.lat;
                    document.getElementById('longitude').value = data.lng;
                } else {
                    alert(data.error || 'Could not geocode that address.');
                }
            })
            .catch(function() { alert('Geocode request failed.'); });
    }

    function toggleJobEdit(id) {
        var nameDisplay = document.getElementById('jobname-display-' + id);
        var nameInput = document.getElementById('jobname-input-' + id);
        var custDisplay = document.getElementById('custname-display-' + id);
        var custInput = document.getElementById('custid-input-' + id);
        var addrDisplay = document.getElementById('addr-display-' + id);
        var addrInput = document.getElementById('addr-input-' + id);
        var latlngDisplay = document.getElementById('latlng-display-' + id);
        var latlngEdit = document.getElementById('latlng-edit-' + id);
        var resetDisplay = document.getElementById('reset-display-' + id);
        var resetEdit = document.getElementById('reset-edit-' + id);
        var editBtn = document.getElementById('jobedit-btn-' + id);
        var saveBtn = document.getElementById('jobsave-btn-' + id);
        var editing = nameInput.style.display === 'none';
        nameDisplay.style.display = editing ? 'none' : '';
        nameInput.style.display = editing ? '' : 'none';
        if (custDisplay) custDisplay.style.display = editing ? 'none' : '';
        if (custInput) custInput.style.display = editing ? '' : 'none';
        addrDisplay.style.display = editing ? 'none' : '';
        addrInput.style.display = editing ? '' : 'none';
        latlngDisplay.style.display = editing ? 'none' : '';
        latlngEdit.style.display = editing ? '' : 'none';
        if (resetDisplay) resetDisplay.style.display = editing ? 'none' : '';
        if (resetEdit) resetEdit.style.display = editing ? '' : 'none';
        editBtn.style.display = editing ? 'none' : '';
        saveBtn.style.display = editing ? '' : 'none';
    }

    function saveJob(id) {
        var job_name = document.getElementById('jobname-input-' + id).value;
        var job_address = document.getElementById('addr-input-' + id).value;
        var lat = document.getElementById('lat-input-' + id).value;
        var lng = document.getElementById('lng-input-' + id).value;
        var custSel = document.getElementById('custid-input-' + id);
        var resetInput = document.getElementById('reset-input-' + id);
        var payload = {job_name: job_name, job_address: job_address};
        if (lat) payload.latitude = parseFloat(lat);
        if (lng) payload.longitude = parseFloat(lng);
        if (custSel) payload.customer_id = custSel.value ? parseInt(custSel.value) : null;
        if (resetInput) payload.reset_per_visit = resetInput.checked ? 1 : 0;
        fetch('/admin/jobs/' + id + '/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(function(resp) {
            if (resp.ok) { window._guardBypass = true; window.location.reload(); }
            else { alert('Error saving job.'); }
        });
    }

    function geocodeJobAddress(id) {
        var address = document.getElementById('addr-input-' + id).value;
        if (!address) { alert('Enter an address first.'); return; }
        fetch('{{ url_for("api_geocode") }}?address=' + encodeURIComponent(address))
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                if (data.lat != null && data.lng != null) {
                    document.getElementById('lat-input-' + id).value = data.lat;
                    document.getElementById('lng-input-' + id).value = data.lng;
                } else {
                    alert(data.error || 'Could not geocode that address.');
                }
            })
            .catch(function() { alert('Geocode request failed.'); });
    }
    </script>
</body>
</html>
