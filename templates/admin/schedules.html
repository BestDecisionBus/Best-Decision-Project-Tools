<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedules — BDB Tools</title>
    <link rel="stylesheet" href="/static/css/style.css?v={{ cache_bust }}">
    <style>
    .day-check {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 8px 0; background: var(--gray-100); border: 1px solid var(--gray-200);
        border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;
        user-select: none; flex: 1; min-width: 0; text-align: center;
    }
    .day-check:has(input:checked) { background: var(--blue); color: #fff; border-color: var(--blue); }
    .day-check input { display: none; }
    .sched-emp-row td { border-bottom: 2px solid var(--gray-400); padding-top: 6px; padding-bottom: 6px; }
    .emp-cb-label { display: flex; align-items: center; gap: 8px; padding: 5px 8px; cursor: pointer; border-radius: 4px; font-size: 14px; }
    .emp-cb-label:hover { background: var(--gray-100); }
    .emp-cb-label input { width: 15px; height: 15px; cursor: pointer; flex-shrink: 0; }
    </style>
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest-admin.json">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
    <div class="admin-layout">
        {% include 'admin/_nav.html' %}

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
        <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endwith %}

        <h2>Schedules</h2>

        {% if current_user.is_bdb %}
            {% if tokens|length > 1 %}
            <div class="form-group" style="max-width: 300px; margin-bottom: 24px;">
                <label for="token-select">Company</label>
                <select id="token-select" onchange="window.location.href='?token=' + this.value">
                    <option value="">Select Company</option>
                    {% for t in tokens %}
                    <option value="{{ t.token }}" {% if token_data and token_data.token == t.token %}selected{% endif %}>{{ t.company_name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        {% else %}
            {% if token_data %}
            <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 16px;">Company: <strong>{{ token_data.company_name }}</strong></p>
            {% endif %}
        {% endif %}

        {% if token_data %}
        {# Week navigation #}
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <button type="button" class="btn btn-blue btn-sm" id="prev-week">&larr; Previous Week</button>
            <strong id="week-label" style="font-size: 16px;"></strong>
            <button type="button" class="btn btn-blue btn-sm" id="next-week">Next Week &rarr;</button>
        </div>

        {# Schedule grid #}
        <div id="schedule-grid" class="table-wrap">
            <table id="schedule-table" style="table-layout: fixed; width: 100%;">
                <thead>
                    <tr id="schedule-header">
                        <th>Employee</th>
                    </tr>
                </thead>
                <tbody id="schedule-body">
                </tbody>
            </table>
        </div>

        {# Add schedule button #}
        <div style="margin-top: 16px;">
            <button type="button" class="btn btn-green" id="add-schedule-btn">Add Schedule</button>
        </div>

        {# Add/Edit Modal #}
        <div id="schedule-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
            <div style="background: white; max-width: 600px; width: 90%; margin: 40px auto; padding: 28px; border-radius: 12px;">
                <h3 id="modal-title" style="margin-top: 0;">Add Schedule</h3>
                <!-- Multi-select employees (shown when adding new schedules) -->
                <div class="form-group" id="emp-multi-group">
                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px;">
                        <label style="margin: 0;">Employees <span style="font-size: 12px; font-weight: 400; color: var(--gray-500);">(select one or more)</span></label>
                        <span style="font-size: 12px; color: var(--blue); cursor: pointer;" onclick="toggleAllEmployees()">Select All / None</span>
                    </div>
                    <div id="emp-checkbox-list" style="max-height: 160px; overflow-y: auto; border: 1px solid var(--gray-200); border-radius: 6px; padding: 6px; background: #fff;">
                        {% for emp in employees %}
                        <label class="emp-cb-label">
                            <input type="checkbox" class="emp-cb" value="{{ emp.id }}"> {{ emp.name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                <!-- Single employee select (shown when editing an existing schedule) -->
                <div class="form-group" id="emp-single-group" style="display: none;">
                    <label for="sched-employee">Employee</label>
                    <select id="sched-employee">
                        <option value="">Select Employee</option>
                        {% for emp in employees %}
                        <option value="{{ emp.id }}">{{ emp.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="sched-job">Job</label>
                    <select id="sched-job">
                        <option value="">Select Job</option>
                        {% for job in jobs %}
                        <option value="{{ job.id }}">{{ job.job_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="sched-date">Date</label>
                    <input type="date" id="sched-date">
                </div>
                <div class="form-group" id="repeat-group">
                    <label>Apply to days</label>
                    <div style="display: flex; gap: 4px; margin-top: 4px;">
                        <label class="day-check"><input type="checkbox" value="0" class="sched-day-cb">Sun</label>
                        <label class="day-check"><input type="checkbox" value="1" class="sched-day-cb" checked>Mon</label>
                        <label class="day-check"><input type="checkbox" value="2" class="sched-day-cb">Tue</label>
                        <label class="day-check"><input type="checkbox" value="3" class="sched-day-cb">Wed</label>
                        <label class="day-check"><input type="checkbox" value="4" class="sched-day-cb">Thu</label>
                        <label class="day-check"><input type="checkbox" value="5" class="sched-day-cb">Fri</label>
                        <label class="day-check"><input type="checkbox" value="6" class="sched-day-cb">Sat</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="sched-shift">Shift</label>
                    <select id="sched-shift" onchange="onShiftChange()">
                        {% for st in shift_types %}
                        <option value="{{ st.id }}" data-start="{{ st.start_time }}" data-end="{{ st.end_time }}">{{ st.name }} ({{ st.start_time|time12 }} - {{ st.end_time|time12 }})</option>
                        {% endfor %}
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div id="custom-times" style="display: none;">
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="sched-start">Start Time</label>
                            <input type="time" id="sched-start" value="07:00">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="sched-end">End Time</label>
                            <input type="time" id="sched-end" value="17:00">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="sched-common-task">Standard Task (optional)</label>
                    <select id="sched-common-task">
                        <option value="">-- None --</option>
                    </select>
                </div>
                <div class="form-group" id="job-task-group" style="display: none;">
                    <label for="sched-job-task">Job-Specific Task (optional)</label>
                    <select id="sched-job-task">
                        <option value="">-- None --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sched-custom-note">Custom Note (optional)</label>
                    <textarea id="sched-custom-note" rows="8" placeholder="e.g. Bring safety gear" style="width: 100%; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
                    <button type="button" class="btn btn-sm" style="background: var(--gray-400);" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-green btn-sm" id="modal-save" onclick="saveSchedule()">Save</button>
                </div>
            </div>
        </div>

        <script>
        var TOKEN = "{{ selected_token }}";
        var currentWeekStart = null;
        var editingId = null;
        var commonTasksList = [];

        var DAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        function escapeHtml(str) {
            if (!str) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function formatTime12(t) {
            if (!t) return '';
            var parts = t.split(':');
            var h = parseInt(parts[0], 10);
            var m = parts[1] || '00';
            var ampm = h >= 12 ? 'pm' : 'am';
            h = h % 12 || 12;
            return h + ':' + m + ampm;
        }

        // Load common tasks for the dropdown
        function loadCommonTasks() {
            if (!TOKEN) return;
            fetch('/api/common-tasks?token=' + TOKEN)
                .then(function(r) { return r.json(); })
                .then(function(tasks) {
                    commonTasksList = tasks;
                    var sel = document.getElementById('sched-common-task');
                    sel.innerHTML = '<option value="">-- None --</option>';
                    tasks.forEach(function(t) {
                        var opt = document.createElement('option');
                        opt.value = t.id;
                        opt.textContent = t.name;
                        sel.appendChild(opt);
                    });
                });
        }

        // Load job-specific tasks when job changes
        function loadJobTasks(jobId) {
            var group = document.getElementById('job-task-group');
            var sel = document.getElementById('sched-job-task');
            sel.innerHTML = '<option value="">-- None --</option>';
            if (!jobId) { group.style.display = 'none'; return; }
            fetch('/api/job-tasks?job_id=' + jobId)
                .then(function(r) { return r.json(); })
                .then(function(tasks) {
                    if (tasks.length > 0) {
                        tasks.forEach(function(t) {
                            var opt = document.createElement('option');
                            opt.value = t.id;
                            opt.textContent = t.name;
                            sel.appendChild(opt);
                        });
                        group.style.display = '';
                    } else {
                        group.style.display = 'none';
                    }
                });
        }

        document.getElementById('sched-job').addEventListener('change', function() {
            loadJobTasks(this.value);
        });

        function getSundayOfWeek(d) {
            d = new Date(d);
            var day = d.getDay();
            d.setDate(d.getDate() - day);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function formatDate(d) {
            return d.toISOString().slice(0, 10);
        }

        function formatShort(d) {
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return months[d.getMonth()] + ' ' + d.getDate();
        }

        function loadWeek() {
            var sun = new Date(currentWeekStart);
            sun.setDate(sun.getDate() + 6);
            document.getElementById('week-label').textContent = formatShort(currentWeekStart) + ' - ' + formatShort(sun);

            // Build header
            var header = document.getElementById('schedule-header');
            header.innerHTML = '<th style="background: var(--gray-100); border-bottom: 2px solid var(--gray-300); width: 120px;">Employee</th>';
            var today = formatDate(new Date());
            for (var i = 0; i < 7; i++) {
                var d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                var isToday = formatDate(d) === today;
                var bg = isToday ? 'background: #dbeafe; border-bottom: 2px solid var(--blue);' : 'background: var(--gray-100); border-bottom: 2px solid var(--gray-300);';
                header.innerHTML += '<th style="' + bg + ' font-size: 12px; padding: 6px 4px; text-align: center;">' + DAY_NAMES[i] + '<br><span style="font-weight: 400; font-size: 11px;">' + formatShort(d) + '</span></th>';
            }

            // Fetch schedules
            var weekEnd = formatDate(sun);
            fetch('/scheduler/api/schedules?week_start=' + formatDate(currentWeekStart) + '&week_end=' + weekEnd + '&token=' + TOKEN)
                .then(function(r) { return r.json(); })
                .then(function(schedules) {
                    renderSchedule(schedules);
                });
        }

        function renderSchedule(schedules) {
            var body = document.getElementById('schedule-body');
            body.innerHTML = '';

            // Group by employee
            var byEmployee = {};
            schedules.forEach(function(s) {
                var key = s.employee_id + '|' + (s.employee_name || 'Unknown');
                if (!byEmployee[key]) byEmployee[key] = {};
                var dateKey = s.date;
                if (!byEmployee[key][dateKey]) byEmployee[key][dateKey] = [];
                byEmployee[key][dateKey].push(s);
            });

            var keys = Object.keys(byEmployee).sort();
            if (keys.length === 0) {
                body.innerHTML = '<tr><td colspan="8" style="color: var(--gray-500); text-align: center;">No schedules for this week.</td></tr>';
                return;
            }

            keys.forEach(function(key) {
                var parts = key.split('|');
                var empName = parts[1];
                var tr = document.createElement('tr');
                tr.className = 'sched-emp-row';
                tr.innerHTML = '<td><strong>' + empName + '</strong></td>';

                for (var i = 0; i < 7; i++) {
                    var d = new Date(currentWeekStart);
                    d.setDate(d.getDate() + i);
                    var dateStr = formatDate(d);
                    var td = document.createElement('td');
                    td.style.verticalAlign = 'top';
                    td.style.fontSize = '12px';
                    td.style.overflow = 'hidden';

                    if (byEmployee[key][dateStr]) {
                        byEmployee[key][dateStr].forEach(function(s) {
                            var div = document.createElement('div');
                            div.style.cssText = 'background: var(--blue-50, #eff6ff); border: 1px solid var(--blue, #2563eb); border-radius: 4px; padding: 4px 6px; margin-bottom: 4px; cursor: pointer; overflow: hidden;';
                            div.innerHTML = '<strong style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + escapeHtml(s.job_name) + '">' + escapeHtml(s.job_name) + '</strong>' + formatTime12(s.start_time) + ' - ' + formatTime12(s.end_time);
                            if (s.notes) div.innerHTML += '<br><em style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; word-break: break-word;">' + escapeHtml(s.notes) + '</em>';
                            div.innerHTML += '<br><span style="color: var(--red); cursor: pointer;" onclick="event.stopPropagation(); deleteSchedule(' + s.id + ')">Delete</span>';
                            div.onclick = function() { editScheduleEntry(s); };
                            td.appendChild(div);
                        });
                    }
                    tr.appendChild(td);
                }
                body.appendChild(tr);
            });
        }

        function onShiftChange() {
            var sel = document.getElementById('sched-shift');
            var val = sel.value;
            var isCustom = val === 'custom';
            document.getElementById('custom-times').style.display = isCustom ? '' : 'none';
            if (!isCustom) {
                var opt = sel.options[sel.selectedIndex];
                var st = opt.getAttribute('data-start');
                var et = opt.getAttribute('data-end');
                if (st) document.getElementById('sched-start').value = st;
                if (et) document.getElementById('sched-end').value = et;
            }
        }

        function openModal(title) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('schedule-modal').style.display = '';
            onShiftChange();
        }

        function toggleAllEmployees() {
            var cbs = document.querySelectorAll('.emp-cb');
            var anyUnchecked = Array.from(cbs).some(function(cb) { return !cb.checked; });
            cbs.forEach(function(cb) { cb.checked = anyUnchecked; });
        }

        function closeModal() {
            document.getElementById('schedule-modal').style.display = 'none';
            editingId = null;
            // Reset multi-select mode
            document.querySelectorAll('.emp-cb').forEach(function(cb) { cb.checked = false; });
            document.getElementById('emp-multi-group').style.display = '';
            document.getElementById('emp-single-group').style.display = 'none';
            document.getElementById('sched-employee').value = '';
            document.getElementById('sched-job').value = '';
            document.getElementById('sched-date').value = '';
            var shiftSel = document.getElementById('sched-shift');
            shiftSel.selectedIndex = 0;
            var firstOpt = shiftSel.options[0];
            var defStart = firstOpt && firstOpt.getAttribute('data-start') ? firstOpt.getAttribute('data-start') : '07:00';
            var defEnd = firstOpt && firstOpt.getAttribute('data-end') ? firstOpt.getAttribute('data-end') : '17:00';
            document.getElementById('sched-start').value = defStart;
            document.getElementById('sched-end').value = defEnd;
            resetDayCheckboxes();
            document.getElementById('repeat-group').style.display = '';
            document.getElementById('sched-common-task').value = '';
            document.getElementById('sched-job-task').value = '';
            document.getElementById('sched-custom-note').value = '';
            document.getElementById('job-task-group').style.display = 'none';
            onShiftChange();
            if (window._markClean) window._markClean();
        }

        document.getElementById('add-schedule-btn').onclick = function() {
            editingId = null;
            document.getElementById('repeat-group').style.display = '';
            openModal('Add Schedule');
        };

        function editScheduleEntry(s) {
            editingId = s.id;
            // Switch to single-employee mode for editing
            document.getElementById('emp-multi-group').style.display = 'none';
            document.getElementById('emp-single-group').style.display = '';
            document.getElementById('sched-employee').value = s.employee_id;
            document.getElementById('sched-job').value = s.job_id;
            document.getElementById('sched-date').value = s.date;
            document.getElementById('sched-shift').value = s.shift_type || 'custom';
            document.getElementById('sched-start').value = s.start_time || '07:00';
            document.getElementById('sched-end').value = s.end_time || '17:00';

            // Set 3-tier task fields
            document.getElementById('sched-common-task').value = s.common_task_id || '';
            document.getElementById('sched-custom-note').value = s.custom_note || '';
            // Load job tasks then set selection
            if (s.job_id) {
                loadJobTasks(s.job_id);
                setTimeout(function() {
                    document.getElementById('sched-job-task').value = s.job_task_id || '';
                }, 300);
            }

            document.getElementById('repeat-group').style.display = 'none';
            onShiftChange();
            openModal('Edit Schedule');
        }

        function resetDayCheckboxes() {
            var cbs = document.querySelectorAll('.sched-day-cb');
            cbs.forEach(function(cb) { cb.checked = false; });
            // Check the day matching the date input
            updateDayCheckboxFromDate();
        }

        function updateDayCheckboxFromDate() {
            var dateVal = document.getElementById('sched-date').value;
            if (!dateVal) return;
            var d = new Date(dateVal + 'T00:00:00');
            var dayNum = d.getDay(); // 0=Sun, 1=Mon...
            var cbs = document.querySelectorAll('.sched-day-cb');
            cbs.forEach(function(cb) {
                if (parseInt(cb.value) === dayNum) cb.checked = true;
            });
        }

        document.getElementById('sched-date').addEventListener('change', function() {
            resetDayCheckboxes();
        });

        function getSelectedDayDates(baseDate) {
            // From the base date, find the Sunday of that week,
            // then return dates for each checked day
            var d = new Date(baseDate + 'T00:00:00');
            var sun = new Date(d);
            sun.setDate(sun.getDate() - d.getDay());

            var cbs = document.querySelectorAll('.sched-day-cb:checked');
            var dates = [];
            cbs.forEach(function(cb) {
                var val = parseInt(cb.value);
                // val: 0=Sun, 1=Mon, 2=Tue, ... 6=Sat
                // offset from Sunday = val directly
                var dt = new Date(sun);
                dt.setDate(dt.getDate() + val);
                dates.push(formatDate(dt));
            });
            return dates;
        }

        function saveSchedule() {
            var jobVal = document.getElementById('sched-job').value;
            var dateVal = document.getElementById('sched-date').value;

            if (!jobVal) { alert('Please select a job.'); return; }
            if (!dateVal) { alert('Please select a date.'); return; }

            var baseData = {
                job_id: parseInt(jobVal),
                token: TOKEN,
                date: dateVal,
                shift_type: document.getElementById('sched-shift').value,
                start_time: document.getElementById('sched-start').value,
                end_time: document.getElementById('sched-end').value,
                common_task_id: document.getElementById('sched-common-task').value || null,
                job_task_id: document.getElementById('sched-job-task').value || null,
                custom_note: document.getElementById('sched-custom-note').value
            };

            // If editing, use the single employee select
            if (editingId) {
                var empVal = document.getElementById('sched-employee').value;
                if (!empVal) { alert('Please select an employee.'); return; }
                var data = Object.assign({}, baseData, {employee_id: parseInt(empVal)});
                fetch('/scheduler/api/schedules/' + editingId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                }).then(function(resp) {
                    if (resp.redirected) { alert('Session expired. Please refresh and log in again.'); return; }
                    if (resp.ok) { closeModal(); loadWeek(); }
                    else { resp.text().then(function(t) { try { var d = JSON.parse(t); alert(d.error || 'Error saving.'); } catch(e) { alert('Error saving schedule (status ' + resp.status + ').'); } }); }
                }).catch(function(err) { alert('Network error: ' + err.message); });
                return;
            }

            // New schedule — collect selected employees
            var empIds = Array.from(document.querySelectorAll('.emp-cb:checked')).map(function(cb) { return parseInt(cb.value); });
            if (empIds.length === 0) { alert('Please select at least one employee.'); return; }

            // Get dates from checked day boxes
            var dates = getSelectedDayDates(baseData.date);
            if (dates.length === 0) {
                alert('Please select at least one day.');
                return;
            }

            // Create a schedule for every employee × every date
            var promises = [];
            empIds.forEach(function(empId) {
                dates.forEach(function(dt) {
                    var entry = Object.assign({}, baseData, {employee_id: empId, date: dt});
                    promises.push(fetch('/scheduler/api/schedules', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'same-origin',
                        body: JSON.stringify(entry)
                    }));
                });
            });

            Promise.all(promises).then(function(results) {
                var failed = results.filter(function(r) { return !r.ok || r.redirected; });
                if (failed.length === 0) {
                    closeModal();
                    loadWeek();
                } else {
                    failed[0].text().then(function(t) {
                        var msg = 'Status ' + failed[0].status;
                        try { var d = JSON.parse(t); if (d.error) msg = d.error; } catch(e) {}
                        alert(failed.length + ' of ' + promises.length + ' schedules failed: ' + msg);
                    }).catch(function() {
                        alert(failed.length + ' of ' + promises.length + ' schedules failed to save.');
                    });
                    loadWeek();
                }
            }).catch(function(err) { alert('Network error: ' + err.message); });
        }

        function deleteSchedule(id) {
            if (!confirm('Delete this schedule entry?')) return;
            fetch('/scheduler/api/schedules/' + id, {method: 'DELETE'})
                .then(function(resp) {
                    if (resp.ok) loadWeek();
                    else alert('Error deleting schedule.');
                });
        }

        // Navigation
        document.getElementById('prev-week').onclick = function() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            loadWeek();
        };
        document.getElementById('next-week').onclick = function() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            loadWeek();
        };

        // Init
        currentWeekStart = getSundayOfWeek(new Date());
        loadWeek();
        loadCommonTasks();
        </script>
        {% else %}
        <p style="color: var(--gray-500);">Select a company above to view schedules.</p>
        {% endif %}
    </div>
    {% include '_footer.html' %}
    <script src="/static/js/admin.js?v={{ cache_bust }}"></script>
</body>
</html>
