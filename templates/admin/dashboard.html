<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard — BDB Tools</title>
    <link rel="stylesheet" href="/static/css/style.css?v={{ cache_bust }}">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest-admin.json">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
    <div class="admin-layout">
        {% include 'admin/_nav.html' %}

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
        <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endwith %}

        <h2>Dashboard</h2>

        {% if current_user.is_bdb %}
            <div class="token-selector">
                <label>Company</label>
                <select class="token-select" onchange="window.location.href='?token=' + this.value">
                    <option value="" {% if not selected_token %}selected{% endif %}>All Companies</option>
                    {% for t in tokens %}
                    <option value="{{ t.token }}" {% if selected_token and selected_token.token == t.token %}selected{% endif %}>{{ t.company_name }}</option>
                    {% endfor %}
                </select>
            </div>
        {% else %}
            {% if selected_token %}
            <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 16px;">Company: <strong>{{ selected_token.company_name }}</strong></p>
            {% endif %}
        {% endif %}

        {% if company_summaries is not none and not selected_token %}
        {# ============================================================
           BDB DASHBOARD — Company Cards + Receipt Stats
           ============================================================ #}

        <div class="company-cards">
            {% for company in company_summaries %}
            <a href="?token={{ company.token }}" class="company-card {% if not company.is_active %}company-card-inactive{% endif %}">
                <div class="company-card-header">
                    {% if company.logo_file %}
                    <img src="/static/logos/{{ company.logo_file }}" alt="{{ company.company_name }}" class="company-card-logo">
                    {% endif %}
                    <h3>{{ company.company_name }}</h3>
                    {% if not company.is_active %}
                    <span class="badge badge-inactive" style="font-size: 10px;">Inactive</span>
                    {% endif %}
                </div>
                <div class="company-card-stats">
                    <div class="company-card-stat">
                        <span class="company-card-stat-value">{{ company.employee_count }}</span>
                        <span class="company-card-stat-label">Employees</span>
                    </div>
                    <div class="company-card-stat">
                        <span class="company-card-stat-value">{{ company.active_jobs }}</span>
                        <span class="company-card-stat-label">Jobs</span>
                    </div>
                    <div class="company-card-stat">
                        <span class="company-card-stat-value {% if company.active_punches > 0 %}company-card-stat-active{% endif %}">{{ company.active_punches }}</span>
                        <span class="company-card-stat-label">Active</span>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>

        {% if not company_summaries %}
        <p style="color: var(--gray-500);">No companies yet. Create a token in the <a href="{{ url_for('admin.admin_tokens') }}">Tokens</a> page.</p>
        {% endif %}

        {% else %}
        {# ============================================================
           COMPANY DASHBOARD — Operations View
           ============================================================ #}

        {% if stats %}
        <div class="stat-cards">
            <div class="stat-card stat-blue">
                <div class="stat-value">{{ stats.scheduled_today }}</div>
                <div class="stat-label">Scheduled Today</div>
            </div>
            <div class="stat-card stat-blue">
                <div class="stat-value">{{ stats.active_punches }}</div>
                <div class="stat-label">Currently Clocked In</div>
            </div>
            <div class="stat-card stat-blue">
                <div class="stat-value">{{ stats.photos_this_week }}</div>
                <div class="stat-label">Photos This Week</div>
            </div>
            <div class="stat-card stat-blue">
                <div class="stat-value">{{ stats.weekly_hours }}</div>
                <div class="stat-label">Weekly Hours</div>
            </div>
            <div class="stat-card" style="border-color: var(--green); background: #f0fdf4;">
                <div class="stat-value" style="color: var(--green); font-size: 22px;">${{ '{:,.2f}'.format(stats.est_weekly_payroll|default(0)) }}</div>
                <div class="stat-label">Est. Weekly Payroll</div>
            </div>
        </div>
        {% endif %}

        {# Section 1: Today's Schedule #}
        <div class="dash-section">
            <h3 class="dash-section-title">Today's Schedule</h3>
            {% if todays_schedules %}
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Job</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Shift</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in todays_schedules %}
                        <tr>
                            <td>{{ s.employee_name }}</td>
                            <td>{{ s.job_name }}</td>
                            <td>{{ s.start_time|time12 }}</td>
                            <td>{{ s.end_time|time12 }}</td>
                            <td><span class="shift-badge shift-badge-{{ s.shift_type }}">{{ s.shift_type }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="dash-empty">No schedules for today.</p>
            {% endif %}
        </div>

        {# Section 2: Who's Clocked In Now #}
        <div class="dash-section">
            <h3 class="dash-section-title">Who's Clocked In Now</h3>
            {% if active_entries %}
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Job</th>
                            <th>Date</th>
                            <th>Clock In</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in active_entries %}
                        <tr>
                            <td>{{ entry.employee_name }}</td>
                            <td>{{ entry.job_name }}</td>
                            <td>{{ entry.clock_in_time|fmt_date }}</td>
                            <td>{{ entry.clock_in_time|fmt_time }}</td>
                            <td>
                                <span class="duration-live" data-clock-in="{{ entry.clock_in_time }}"></span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="dash-empty">No one clocked in right now.</p>
            {% endif %}
        </div>

        {# Section 4: Weekly Payroll Estimate #}
        {% if payroll_estimate and payroll_estimate.employees %}
        <div class="dash-section">
            <h3 class="dash-section-title">Weekly Payroll Estimate</h3>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th style="text-align: right;">Reg Hrs</th>
                            <th style="text-align: right;">OT Hrs</th>
                            <th style="text-align: right;">Rate</th>
                            <th style="text-align: right;">Base Pay</th>
                            <th style="text-align: right;">Burden ({{ payroll_estimate.burden_pct }}%)</th>
                            <th style="text-align: right;">Total Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emp in payroll_estimate.employees %}
                        <tr>
                            <td>{{ emp.employee_name }}</td>
                            <td style="text-align: right;">{{ emp.regular_hours }}</td>
                            <td style="text-align: right;{% if emp.ot_hours > 0 %} color: #dc2626; font-weight: 600;{% endif %}">{{ emp.ot_hours }}</td>
                            <td style="text-align: right;">{% if emp.hourly_wage is not none %}${{ '%.2f'|format(emp.hourly_wage) }}{% else %}—{% endif %}</td>
                            <td style="text-align: right;">{% if emp.base_pay is not none %}${{ '{:,.2f}'.format(emp.base_pay) }}{% else %}—{% endif %}</td>
                            <td style="text-align: right;">{% if emp.burden is not none %}${{ '{:,.2f}'.format(emp.burden) }}{% else %}—{% endif %}</td>
                            <td style="text-align: right; font-weight: 600;">{% if emp.total_cost is not none %}${{ '{:,.2f}'.format(emp.total_cost) }}{% else %}—{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: 700; border-top: 2px solid var(--gray-300);">
                            <td>Company Total</td>
                            <td style="text-align: right;">{{ payroll_estimate.total_regular_hours }}</td>
                            <td style="text-align: right;{% if payroll_estimate.total_ot_hours > 0 %} color: #dc2626;{% endif %}">{{ payroll_estimate.total_ot_hours }}</td>
                            <td style="text-align: right;"></td>
                            <td style="text-align: right;">${{ '{:,.2f}'.format(payroll_estimate.total_base) }}</td>
                            <td style="text-align: right;">${{ '{:,.2f}'.format(payroll_estimate.total_burden) }}</td>
                            <td style="text-align: right;">${{ '{:,.2f}'.format(payroll_estimate.total_cost) }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <p style="font-size: 12px; color: var(--gray-400); margin-top: 8px; font-style: italic;">Estimate only — Not for bookkeeping purposes</p>
        </div>
        {% endif %}

        {# Section 5: Job Labor Costs — Week to Date + All Time #}
        {% if combined_job_costs and combined_job_costs.jobs %}
        <div class="dash-section">
            <h3 class="dash-section-title">Labor Cost by Job</h3>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Job</th>
                            <th style="text-align: right;">This Week Hrs</th>
                            <th style="text-align: right;">This Week Cost</th>
                            <th style="text-align: right;">All Time Hrs</th>
                            <th style="text-align: right;">All Time Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for j in combined_job_costs.jobs %}
                        <tr>
                            <td>{{ j.job_name }}</td>
                            <td style="text-align: right;">{{ j.week_hours }}</td>
                            <td style="text-align: right;">${{ '{:,.2f}'.format(j.week_cost) }}</td>
                            <td style="text-align: right;">{{ j.alltime_hours }}</td>
                            <td style="text-align: right; font-weight: 600;">${{ '{:,.2f}'.format(j.alltime_cost) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: 700; border-top: 2px solid var(--gray-300);">
                            <td>Total</td>
                            <td style="text-align: right;">{{ combined_job_costs.total_week_hours }}</td>
                            <td style="text-align: right;">${{ '{:,.2f}'.format(combined_job_costs.total_week_cost) }}</td>
                            <td style="text-align: right;">{{ combined_job_costs.total_alltime_hours }}</td>
                            <td style="text-align: right;">${{ '{:,.2f}'.format(combined_job_costs.total_alltime_cost) }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <p style="font-size: 12px; color: var(--gray-400); margin-top: 8px; font-style: italic;">Estimate only — Not for bookkeeping purposes</p>
        </div>
        {% endif %}

        {# Section 6: Estimates — Year to Date #}
        {% if estimate_stats %}
        <div class="dash-section">
            <h3 class="dash-section-title">Estimates &mdash; Year to Date</h3>
            <div class="stat-cards">
                <div class="stat-card" style="border-color: #f59e0b; background: #fffbeb;">
                    <div class="stat-value" style="color: #b45309;">{{ estimate_stats.pending.count }}</div>
                    <div class="stat-label">Pending</div>
                    <div style="font-size: 16px; font-weight: 600; color: #b45309; margin-top: 4px;">${{ '{:,.0f}'.format(estimate_stats.pending.total) }}</div>
                </div>
                <div class="stat-card" style="border-color: #3b82f6; background: #eff6ff;">
                    <div class="stat-value" style="color: #1d4ed8;">{{ estimate_stats.accepted.count }}</div>
                    <div class="stat-label">Accepted</div>
                    <div style="font-size: 16px; font-weight: 600; color: #1d4ed8; margin-top: 4px;">${{ '{:,.0f}'.format(estimate_stats.accepted.total) }}</div>
                </div>
                <div class="stat-card" style="border-color: var(--green); background: #f0fdf4;">
                    <div class="stat-value" style="color: var(--green);">{{ estimate_stats.completed.count }}</div>
                    <div class="stat-label">Completed</div>
                    <div style="font-size: 16px; font-weight: 600; color: var(--green); margin-top: 4px;">${{ '{:,.0f}'.format(estimate_stats.completed.total) }}</div>
                </div>
                <div class="stat-card" style="border-color: #dc2626; background: #fef2f2;">
                    <div class="stat-value" style="color: #dc2626;">{{ estimate_stats.declined.count }}</div>
                    <div class="stat-label">Declined</div>
                    <div style="font-size: 16px; font-weight: 600; color: #dc2626; margin-top: 4px;">${{ '{:,.0f}'.format(estimate_stats.declined.total) }}</div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Quick Actions #}
        <div style="margin-top: 24px; display: flex; gap: 8px; flex-wrap: wrap;">
            <a href="{{ url_for('time_admin.admin_manual_entry') }}{% if selected_token %}?token={{ selected_token.token }}{% endif %}" class="btn btn-green" style="flex: 1 1 0; min-width: 140px; text-align: center;">Manual Clock In/Out</a>
            <a href="{{ url_for('scheduling.admin_schedules') }}{% if selected_token %}?token={{ selected_token.token }}{% endif %}" class="btn btn-green" style="flex: 1 1 0; min-width: 140px; text-align: center;">Add to Schedule</a>
            <a href="{{ url_for('time_admin.admin_jobs') }}{% if selected_token %}?token={{ selected_token.token }}{% endif %}" class="btn btn-green" style="flex: 1 1 0; min-width: 140px; text-align: center;">New Job Site</a>
            <a href="{{ url_for('estimates.admin_estimates') }}{% if selected_token %}?token={{ selected_token.token }}{% endif %}" class="btn btn-blue" style="flex: 1 1 0; min-width: 140px; text-align: center;">View Estimates</a>
            <a href="{{ url_for('job_photos.admin_job_photos') }}{% if selected_token %}?token={{ selected_token.token }}{% endif %}" class="btn btn-blue" style="flex: 1 1 0; min-width: 140px; text-align: center;">View Job Photos</a>
            <a href="{{ url_for('receipt_admin.receipt_dashboard') }}{% if selected_token %}?token={{ selected_token.token }}{% endif %}" class="btn btn-green" style="flex: 1 1 0; min-width: 140px; text-align: center;">Process Receipt</a>
        </div>
        {% endif %}
    </div>
    {% include '_footer.html' %}
    <script src="/static/js/admin.js?v={{ cache_bust }}"></script>
    <script>
    // Live duration counter for clocked-in entries
    (function() {
        function updateDurations() {
            var els = document.querySelectorAll('.duration-live');
            var now = new Date();
            els.forEach(function(el) {
                var clockIn = el.getAttribute('data-clock-in');
                if (!clockIn) return;
                var start = new Date(clockIn);
                var diff = Math.max(0, Math.floor((now - start) / 1000));
                var h = Math.floor(diff / 3600);
                var m = Math.floor((diff % 3600) / 60);
                el.textContent = h + 'h ' + m + 'm';
            });
        }
        updateDurations();
        setInterval(updateDurations, 60000);
    })();
    </script>
</body>
</html>
