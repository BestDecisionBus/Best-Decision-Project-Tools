<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ template.name }} — Task Templates — BDB Tools</title>
    <link rel="stylesheet" href="/static/css/style.css?v={{ cache_bust }}">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest-admin.json">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
    <div class="admin-layout">
        {% include 'admin/_nav.html' %}

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
        <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endwith %}

        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px; flex-wrap: wrap;">
            <a href="{{ url_for('task_templates.admin_task_templates', token=selected_token.token if selected_token else '') }}"
               class="btn btn-blue btn-sm">&larr; All Templates</a>
            <h2 style="margin: 0;" id="tpl-name-display">{{ template.name }}</h2>
            {% if template.is_active %}
            <span class="badge badge-active">Active</span>
            {% else %}
            <span class="badge badge-inactive">Inactive</span>
            {% endif %}
        </div>

        {% if selected_token %}
        <p style="font-size: 14px; color: var(--gray-500); margin-bottom: 16px;">Company: <strong>{{ selected_token.company_name }}</strong></p>
        {% endif %}

        {# Edit template name #}
        <div class="meta-card" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <span id="tpl-edit-display" style="font-size: 15px; font-weight: 600;">{{ template.name }}</span>
                <input type="text" id="tpl-edit-input" value="{{ template.name }}"
                       style="display: none; font-size: 15px; padding: 4px 8px; border: 1px solid var(--gray-300); border-radius: 6px; flex: 1; min-width: 200px;">
                <button type="button" class="btn btn-blue btn-sm" id="tpl-edit-btn"
                        onclick="toggleTplEdit()">Rename</button>
                <button type="button" class="btn btn-green btn-sm" id="tpl-save-btn"
                        style="display: none;" onclick="saveTplName()">Save Name</button>
            </div>
        </div>

        {# Add item form #}
        <div class="meta-card" style="margin-bottom: 24px;">
            <h3 style="margin-top: 0;">Add Task</h3>
            <form method="POST" action="{{ url_for('task_templates.admin_template_item_create', template_id=template.id) }}">
                <input type="hidden" name="token" value="{{ selected_token.token if selected_token else '' }}">
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label for="item-desc">Task Description</label>
                        <input type="text" id="item-desc" name="description"
                               placeholder="e.g. Vacuum all floors" required>
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="submit" class="btn btn-green">Add Task</button>
                    </div>
                </div>
            </form>
        </div>

        {% if items %}
        <div class="table-wrap">
            <table class="resizable sortable">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Sort Order</th>
                        <th>Status</th>
                        <th data-no-sort>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>
                            <span id="item-display-{{ item.id }}">{{ item.description }}</span>
                            <input type="text" id="item-input-{{ item.id }}" value="{{ item.description }}"
                                   style="display: none; width: 100%;">
                        </td>
                        <td>
                            <input type="number" value="{{ item.sort_order }}" class="sort-input"
                                   onchange="saveSortOrder(this)"
                                   data-endpoint="/admin/task-templates/{{ template.id }}/items/{{ item.id }}/sort">
                        </td>
                        <td>
                            {% if item.is_active %}
                            <span class="badge badge-active">Active</span>
                            {% else %}
                            <span class="badge badge-inactive">Inactive</span>
                            {% endif %}
                        </td>
                        <td style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-blue btn-sm" id="item-edit-btn-{{ item.id }}"
                                    onclick="toggleItemEdit({{ item.id }})">Edit</button>
                            <button type="button" class="btn btn-green btn-sm" id="item-save-btn-{{ item.id }}"
                                    style="display: none;" onclick="saveItem({{ item.id }})">Save</button>
                            <form method="POST" action="{{ url_for('task_templates.admin_template_item_toggle', template_id=template.id, item_id=item.id) }}" style="display: inline;">
                                <input type="hidden" name="token" value="{{ selected_token.token if selected_token else '' }}">
                                {% if item.is_active %}
                                <button type="submit" class="btn btn-red btn-sm">Deactivate</button>
                                {% else %}
                                <button type="submit" class="btn btn-green btn-sm">Activate</button>
                                {% endif %}
                            </form>
                            <form method="POST" action="{{ url_for('task_templates.admin_template_item_delete', template_id=template.id, item_id=item.id) }}" style="display: inline;"
                                  onsubmit="return confirm('Delete this task?');">
                                <input type="hidden" name="token" value="{{ selected_token.token if selected_token else '' }}">
                                <button type="submit" class="btn btn-red btn-sm">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="color: var(--gray-500);">No tasks in this template yet. Add one above.</p>
        {% endif %}

    </div>
    {% include '_footer.html' %}
    <script src="/static/js/admin.js?v={{ cache_bust }}"></script>
    <script>
    const TEMPLATE_ID = {{ template.id }};
    const TOKEN = "{{ selected_token.token if selected_token else '' }}";

    function toggleTplEdit() {
        var disp = document.getElementById('tpl-edit-display');
        var inp  = document.getElementById('tpl-edit-input');
        var editBtn = document.getElementById('tpl-edit-btn');
        var saveBtn = document.getElementById('tpl-save-btn');
        var editing = inp.style.display === 'none';
        disp.style.display = editing ? 'none' : '';
        inp.style.display  = editing ? '' : 'none';
        editBtn.style.display = editing ? 'none' : '';
        saveBtn.style.display = editing ? '' : 'none';
        if (editing) inp.focus();
    }

    function saveTplName() {
        var name = document.getElementById('tpl-edit-input').value.trim();
        if (!name) return;
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/task-templates/' + TEMPLATE_ID + '/edit?token=' + TOKEN;
        var hidToken = document.createElement('input');
        hidToken.type = 'hidden'; hidToken.name = 'token'; hidToken.value = TOKEN;
        var hidName = document.createElement('input');
        hidName.type = 'hidden'; hidName.name = 'name'; hidName.value = name;
        form.appendChild(hidToken); form.appendChild(hidName);
        document.body.appendChild(form);
        form.submit();
    }

    function toggleItemEdit(id) {
        var disp = document.getElementById('item-display-' + id);
        var inp  = document.getElementById('item-input-' + id);
        var editBtn = document.getElementById('item-edit-btn-' + id);
        var saveBtn = document.getElementById('item-save-btn-' + id);
        var editing = inp.style.display === 'none';
        disp.style.display = editing ? 'none' : '';
        inp.style.display  = editing ? '' : 'none';
        editBtn.style.display = editing ? 'none' : '';
        saveBtn.style.display = editing ? '' : 'none';
        if (editing) inp.focus();
    }

    function saveItem(id) {
        var desc = document.getElementById('item-input-' + id).value.trim();
        if (!desc) return;
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/task-templates/' + TEMPLATE_ID + '/items/' + id + '/edit';
        var hidToken = document.createElement('input');
        hidToken.type = 'hidden'; hidToken.name = 'token'; hidToken.value = TOKEN;
        var hidDesc = document.createElement('input');
        hidDesc.type = 'hidden'; hidDesc.name = 'description'; hidDesc.value = desc;
        form.appendChild(hidToken); form.appendChild(hidDesc);
        document.body.appendChild(form);
        form.submit();
    }
    </script>
</body>
</html>
